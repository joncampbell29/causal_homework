---
title: "Homework 2"
author: "Jon Campbell"
format: pdf
editor: visual
---

```{r}
#| label: load-packages
#| message: false

library(tidyverse)
library(knitr)
library(PSweight)
library(lme4)
```

## Part 1

### Question 1

```{r}
hsr <- read.table("data/hw2/HSR.txt", header = TRUE)
hsr <- hsr |>
  mutate(pg = if_else(pg == 2,1,0)) |> #Z = 1 (group 2), 0 (Group 1)
  mutate(across(-c(i_age,com_t,mcs_sd,pcs_sd), factor)) |>
  rename(z = pg, y = i_aqoc)

```

{{< pagebreak >}}

#### a)

```{r}

ps.form <- z ~ i_age + i_sex + i_race + i_educ + i_insu + i_drug + i_seve + com_t + pcs_sd + mcs_sd

pscore_summary <- SumStat(ps.formula = ps.form
                            , weight = c('IPW','overlap')
                            ,data = hsr)
hsr$pscore <- pscore_summary$propensity[,2]

ggplot(hsr, aes(x = pscore, fill = z)) +
  geom_density(alpha = 0.5) +
  labs(title = "Distribution of Propensity Scores",
       subtitle = "By Treatment Group (Group 2 = Blue, Group 1 = Red",
       x = "Propensity Scores",
       fill = "Treatment Group")

plot(pscore_summary, metric = "ASD")

```

There is pretty good overlap from the distribution of propensity scores by treatment group.
From the love plot we see that most of the covariates have an ASD above 0.1 when unweighted but perform much better with IPW. mcs_sd and severity2 are slightly above 0.1 and race2 is around 0.35 under IPW. The covariates are perfected balanced with overlap weighing.


```{r}
#With trimming set at 0.05
hsr.trim <- PStrim(ps.formula = ps.form
                   ,data = hsr, delta = 0.1)[["data"]] |>
  ungroup()

pscore_summary <- SumStat(ps.formula = ps.form
                          , weight = c('IPW','overlap')
                          ,data = hsr.trim)

hsr.trim <- hsr.trim |>
  mutate(pscore = pscore_summary$propensity[,2])
```

{{< pagebreak >}}

#### b)

```{r}
ggplot(hsr.trim, aes(x = pscore, fill = z)) +
  geom_density(alpha = 0.5) +
  labs(title = "Distribution of Propensity Scores (Trimmed)",
       subtitle = "By Treatment Group (Group 2 = Blue, Group 1 = Red",
       x = "Propensity Scores",
       fill = "Treatment Group")

#checking balance via ASD
plot(pscore_summary, metric = "ASD")
```

From the love plot we see better performance from IPW weighting after trimming 5% of the data. All the ASDs are below 0.1 for IPW. Not much change in overlap, it is still good.


{{< pagebreak >}}


#### c)

```{r}
#Inverse Probability Weights 
hsr.trim <- hsr.trim |>
  mutate(w = ifelse(z == 1, 1/pscore, 1/(1-pscore)))



table1 <- cbind(
  pscore_summary[["unweighted.sumstat"]][,1:2],
  pscore_summary[["IPW.sumstat"]][,1:2],
  pscore_summary[["overlap.sumstat"]][,1:2]
)
colnames(table1) = c("Original.0", "Original.trt"
                     ,"IPW.0","IPW.trt"
                     , "Overlap.0","Overlap.trt")
table1 |>round(4)
```


{{< pagebreak >}}

#### d)

```{r}

hsr.trimmed <- data.frame(hsr.trim) |>
  mutate(across(c(1,3:8,12),function(x){as.numeric(levels(x))[x]})) |>
  mutate(across(c(2,9:11),scale))

ate.ipw<- summary(lm(y ~ z,data=hsr.trimmed
                     ,weights=hsr.trimmed$w))$coefficients[2,1:2]

ate.ipw.norm <- summary(PSweight(ps.formula = ps.form, yname = "y"
                                 ,data = hsr.trimmed, weight = "IPW"),contrast =c(1,-1))$estimates[,1:2]
ato <- summary(PSweight(ps.formula = ps.form, yname = "y", data = hsr.trimmed
                    , weight = "overlap"),contrast =c(1,-1))$estimates[,1:2]

res <- rbind(
  abs(ate.ipw),
  ate.ipw.norm,
  ato
)
rownames(res) <- c("ATE NonNormalized","ATE Normalized", "ATO")
res
```

{{< pagebreak >}}

### Question 2

#### a)

```{r}

ps.form <- z ~ i_age + i_sex + i_race + i_educ + i_insu + i_drug + i_seve + com_t + pcs_sd + mcs_sd

ps <- glm(ps.form, family = "binomial"
                   , data = hsr.trim)$fitted.values
hsr.trim <- hsr.trim |> mutate(pscore = ps)
hsr_subsetted <- subset(hsr.trim, i_sex == 1)

hsr_subsetted$w <- ifelse(hsr_subsetted$z == 1, 1/hsr_subsetted$pscore
                          , 1/(1-hsr_subsetted$pscore))
z <- as.numeric(levels(hsr_subsetted$z))[hsr_subsetted$z]
y <- as.numeric(levels(hsr_subsetted$y))[hsr_subsetted$y]
w <- hsr_subsetted$w

att.subgroup <- mean(y*z*w - y*(1-z)*w)
att.subgroup
```
ATT is `r att.subgroup`


{{< pagebreak >}}

#### b)

```{r}
ps.form <- z ~ i_age + i_race + i_educ + i_insu + i_drug + i_seve + com_t + pcs_sd + mcs_sd

ps <- glm(ps.form, family = "binomial"
                   , data = hsr.trim)$fitted.values

hsr.trim <- hsr.trim |> mutate(pscore = ps)
hsr_subsetted <- subset(hsr.trim, i_sex == 1)

hsr_subsetted$w <- ifelse(hsr_subsetted$z == 1, 1/hsr_subsetted$pscore
                          , 1/(1-hsr_subsetted$pscore))
z <- as.numeric(levels(hsr_subsetted$z))[hsr_subsetted$z]
y <- as.numeric(levels(hsr_subsetted$y))[hsr_subsetted$y]
w <- hsr_subsetted$w

att.subgroup <- mean(y*z*w - y*(1-z)*w)
att.subgroup
```
Att is `r att.subgroup`


{{< pagebreak >}}

#### c)

```{r}

hsr_subsetted <- subset(hsr.trim, i_sex == 1)

ps.form <- z ~ i_age + i_race + i_educ + i_insu + i_drug + i_seve + com_t + pcs_sd + mcs_sd

ps <- glm(ps.form, family = "binomial"
                   , data = hsr_subsetted)$fitted.values

hsr_subsetted <- hsr_subsetted |> mutate(pscore = ps)

hsr_subsetted$w <- ifelse(hsr_subsetted$z == 1, 1/hsr_subsetted$pscore
                          , 1/(1-hsr_subsetted$pscore))
z <- as.numeric(levels(hsr_subsetted$z))[hsr_subsetted$z]
y <- as.numeric(levels(hsr_subsetted$y))[hsr_subsetted$y]
w <- hsr_subsetted$w

att.subgroup <- mean(y*z*w - y*(1-z)*w)
att.subgroup
```
ATT is `r att.subgroup`


Option (b) is most likely the best way to estimate $E[Y(1)|V=1)] - E[Y(2)|V=1]$ because it adjusts the propensity score estimation to the subgroup. This helps with incorporating information specific to V=1. It also leaves out sex when calculating propensity scores so the weights are not influenced by the effects of sex=1. (b) also uses the whole data unlike (c) when getting propensity scores so sex isn't completely thrown away.




### Question 3

(b) and (d) seem most correct because they are getting $p_z$ from gettign the average probabilities within a treatment group.




{{< pagebreak >}}

## Part 2

```{r}
brscn <- read.table("data/hw2/brscn.txt", header = TRUE)


brscn.fact <- brscn |>
  mutate(across(2:12,factor))

```

### Question 1

```{r}

form <- black ~ agecat + mcaid + poor + cendivis + model + taxstat + affil + blprop + blproplogit + (1|group)


fit <- glmer(form, family = "binomial", data = brscn.fact)
pscores <- predict(fit, type = "response")
brscn.fact <- brscn.fact |>
  mutate(pscore = pscores) |>
  mutate(w = if_else(black == 1, 1/pscore, 1/(1-pscore)))

```


```{r}

brscn <- brscn.fact |>
  mutate(across(c(group,black,brscn),function(x){as.numeric(levels(x))[x]}))

get_trt_effect <- function(num,dat) {
  filt <- dat |> filter(group == num)
  z <- filt$black
  y <- filt$brscn
  w <- filt$w

  res <- list(
    trt.effect = sum(y*z*w)/sum(z*w) - sum(y*(1-z)*w)/sum((1-z)*w),
    grp.weight = sum(w)
  )
  S <- 50
  boot <- numeric(S)
  for (i in 1:S) {
    boot.sample <- filt[sample(nrow(filt)
                                  , nrow(filt), replace = TRUE), ]
    z <- boot.sample$black
    y <- boot.sample$brscn
    w <- boot.sample$w
    boot[i] <- sum(y*z*w)/sum(z*w) - sum(y*(1-z)*w)/sum((1-z)*w)
  }
  
  res["se"] <- sum((boot - res$trt.effect)^2)/(length(boot)-1)
  
  res
}


grps <- unique(brscn$group)

trt.effects <- numeric(length(grps))
grp.weights <- numeric(length(grps))
boot.se <- numeric(length(grps))
for (i in seq_along(grps)) {
  res <- get_trt_effect(grps[i],brscn)
  trt.effects[i] <- res$trt.effect
  grp.weights[i] <- res$grp.weight
  boot.se[i] <- res$se
}

grp.weights.norm <- grp.weights/sum(grp.weights)
ate <- sum(trt.effects*grp.weights.norm)/length(grps)
boot.st.error <- sum(boot.se*grp.weights.norm)/length(grps)

cbind(ate,boot.st.error)
```




